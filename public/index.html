<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ğŸ¹ Mini FL Studio</title>
<style>
body {
  background: #111;
  color: #fff;
  margin: 0;
  font-family: monospace;
  overflow: hidden;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
.controls {
  position: fixed;
  top: 0;
  width: 100%;
  background: #222;
  text-align: center;
  padding: 0.5rem;
  z-index: 10;
}
button {
  margin: 0.3rem;
  padding: 0.5rem 1rem;
  background: #444;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
}
#pianoRoll {
  position: absolute;
  top: 3rem;
  left: 0;
  width: 100%;
  height: calc(100vh - 3rem);
  background: #1e1e1e;
  touch-action: none;
}
</style>
</head>
<body>

<div class="controls">
  <button id="playBtn">â–¶ï¸ ì¬ìƒ</button>
  <button id="stopBtn">â¹ï¸ ì •ì§€</button>
  <button id="clearBtn">ğŸ§¹ ì „ì²´ì‚­ì œ</button>
</div>

<canvas id="pianoRoll"></canvas>

<script>
const canvas = document.getElementById("pianoRoll");
const ctx = canvas.getContext("2d");
const playBtn = document.getElementById("playBtn");
const stopBtn = document.getElementById("stopBtn");
const clearBtn = document.getElementById("clearBtn");

// ğŸ”§ í¬ê¸° ìë™ ì¡°ì •
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 48;
  drawGrid();
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

let notes = JSON.parse(localStorage.getItem("notes") || "[]");
const noteHeight = 30;
const noteWidth = 60;
let isDragging = false, dragNote = null;
let audioCtx, isPlaying = false;

// ğŸ¨ ê·¸ë¦¬ë“œ ë° ë…¸íŠ¸ ë Œë”ë§
function drawGrid() {
  ctx.fillStyle = "#1e1e1e";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  for (let y = 0; y < canvas.height; y += noteHeight) {
    ctx.fillStyle = y % 60 === 0 ? "#2a2a2a" : "#252525";
    ctx.fillRect(0, y, canvas.width, noteHeight - 1);
  }

  // ë…¸íŠ¸ í‘œì‹œ
  notes.forEach(n => {
    ctx.fillStyle = "#0f0";
    ctx.fillRect(n.x, n.y, n.width, noteHeight - 2);
  });
}

// ğŸ“± í„°ì¹˜ ì´ë²¤íŠ¸
function getTouchPos(e) {
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];
  return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
}

canvas.addEventListener("touchstart", e => {
  const { x, y } = getTouchPos(e);
  const gridX = Math.floor(x / noteWidth) * noteWidth;
  const gridY = Math.floor(y / noteHeight) * noteHeight;

  const clicked = notes.find(n =>
    x >= n.x && x <= n.x + n.width && y >= n.y && y <= n.y + noteHeight
  );

  if (clicked) {
    dragNote = clicked;
    isDragging = true;
  } else {
    notes.push({ x: gridX, y: gridY, width: noteWidth });
  }
  drawGrid();
});

canvas.addEventListener("touchmove", e => {
  if (isDragging && dragNote) {
    const { x } = getTouchPos(e);
    dragNote.width = Math.max(noteWidth, Math.floor((x - dragNote.x) / noteWidth) * noteWidth);
    drawGrid();
  }
});

canvas.addEventListener("touchend", () => {
  isDragging = false;
  dragNote = null;
  localStorage.setItem("notes", JSON.stringify(notes));
});

// ğŸµ ì˜¤ë””ì˜¤ ì¬ìƒ
playBtn.addEventListener("click", () => {
  if (isPlaying) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  isPlaying = true;
  const bpm = 120;
  const beat = 60 / bpm;

  notes.forEach(n => {
    const time = (n.x / noteWidth) * beat * 0.5;
    const dur = (n.width / noteWidth) * beat * 0.5;
    const pitch = 220 * Math.pow(2, (canvas.height - n.y) / noteHeight / 12);
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime + time);
    osc.frequency.setValueAtTime(pitch, audioCtx.currentTime + time);
    osc.start(audioCtx.currentTime + time);
    osc.stop(audioCtx.currentTime + time + dur);
  });
  setTimeout(() => isPlaying = false, 4000);
});

stopBtn.addEventListener("click", () => {
  if (audioCtx) audioCtx.close();
  isPlaying = false;
});

clearBtn.addEventListener("click", () => {
  notes = [];
  localStorage.removeItem("notes");
  drawGrid();
});

drawGrid();
</script>
</body>
</html>
