<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>🎵 MP3 Pitch Controller</title>
<style>
body {
  background: #111;
  color: #fff;
  margin: 0;
  font-family: monospace;
  text-align: center;
  overflow: hidden;
}
h1 {
  margin-top: 1.5rem;
}
input[type=file] {
  background: #333;
  color: #fff;
  border: none;
  padding: 0.5rem;
  border-radius: 8px;
  margin: 1rem 0;
}
button {
  background: #444;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 0.5rem 1rem;
  font-size: 1rem;
  margin: 0.3rem;
}
#controls {
  margin-top: 1rem;
}
#pitch {
  width: 80%;
  margin: 1rem 0;
}
label {
  display: block;
  margin-top: 0.5rem;
}
canvas {
  width: 90%;
  height: 120px;
  background: #222;
  margin: 1rem auto;
  border-radius: 8px;
  display: block;
}
</style>
</head>
<body>

<h1>🎵 MP3 피치 조정 툴</h1>
<input type="file" id="fileInput" accept="audio/*">
<canvas id="visualizer"></canvas>

<div id="controls">
  <label>피치 조정: <span id="pitchValue">1.0x</span></label>
  <input type="range" id="pitch" min="0.5" max="2" step="0.01" value="1">
  <br>
  <button id="playBtn">▶️ 재생</button>
  <button id="pauseBtn">⏸️ 일시정지</button>
  <button id="stopBtn">⏹️ 정지</button>
</div>

<script>
let audioCtx, source, analyser, buffer, gainNode;
let isPlaying = false;
let startTime = 0;
let pausedAt = 0;
let pitch = 1.0;

const fileInput = document.getElementById("fileInput");
const playBtn = document.getElementById("playBtn");
const pauseBtn = document.getElementById("pauseBtn");
const stopBtn = document.getElementById("stopBtn");
const pitchSlider = document.getElementById("pitch");
const pitchValue = document.getElementById("pitchValue");
const canvas = document.getElementById("visualizer");
const ctx2d = canvas.getContext("2d");

fileInput.addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  const arrayBuffer = await file.arrayBuffer();
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  buffer = await audioCtx.decodeAudioData(arrayBuffer);

  analyser = audioCtx.createAnalyser();
  gainNode = audioCtx.createGain();
  analyser.fftSize = 1024;
  drawVisualizer();
});

function playAudio(offset = 0) {
  if (!buffer) return;
  source = audioCtx.createBufferSource();
  source.buffer = buffer;
  source.playbackRate.value = pitch;
  source.connect(analyser);
  analyser.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  startTime = audioCtx.currentTime - offset;
  source.start(0, offset);
  isPlaying = true;

  source.onended = () => {
    isPlaying = false;
  };
}

function stopAudio() {
  if (source) {
    source.stop();
    isPlaying = false;
    pausedAt = 0;
  }
}

playBtn.onclick = () => {
  if (!isPlaying) {
    playAudio(pausedAt);
  }
};

pauseBtn.onclick = () => {
  if (isPlaying && source) {
    source.stop();
    pausedAt = audioCtx.currentTime - startTime;
    isPlaying = false;
  }
};

stopBtn.onclick = () => {
  stopAudio();
};

pitchSlider.oninput = e => {
  pitch = parseFloat(e.target.value);
  pitchValue.textContent = pitch.toFixed(2) + "x";
  if (source) source.playbackRate.value = pitch;
};

// 🎶 비주얼라이저
function drawVisualizer() {
  requestAnimationFrame(drawVisualizer);
  if (!analyser) return;
  const dataArray = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(dataArray);
  ctx2d.fillStyle = "#111";
  ctx2d.fillRect(0, 0, canvas.width, canvas.height);
  const barWidth = (canvas.width / dataArray.length);
  for (let i = 0; i < dataArray.length; i++) {
    const barHeight = dataArray[i];
    ctx2d.fillStyle = "#0f0";
    ctx2d.fillRect(i * barWidth, canvas.height - barHeight / 2, barWidth, barHeight / 2);
  }
}
</script>
</body>
</html>